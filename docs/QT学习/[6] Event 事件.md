# [6] Event 事件

# 1. 事件基础

### 1.1 什么是事件

事件是一种用于处理用户交互和系统状态变化的机制。Qt的事件系统基于事件驱动编程模型，它允许应用程序捕获和响应各种事件，例如鼠标点击、键盘按键、窗口尺寸调整、定时器事件等等。

事件在Qt中以`QEvent`​类的实例表示，每种类型的事件都对应一个特定的`QEvent`​子类。例如，`QMouseEvent`​表示鼠标事件，`QKeyEvent`​表示键盘事件，`QResizeEvent`​表示窗口尺寸调整事件，等等。

Qt中的事件处理是通过重写特定的事件处理函数来完成的，这些函数通常位于Qt对象的子类中。例如，如果你想处理鼠标事件，可以重写`QWidget`​类的`mousePressEvent`​、`mouseReleaseEvent`​等函数。当发生相应的事件时，Qt会调用这些函数，从而触发事件处理代码的执行。

‍

### 1.2 谁发出事件

在Qt中，事件通常由操作系统、用户输入设备（如鼠标、键盘）或其他Qt对象发出。以下是一些常见的事件源：

1. **操作系统事件：**  操作系统会生成一些事件，例如窗口尺寸调整、窗口关闭等。这些事件通常由Qt的窗口系统集成进行处理。
2. **用户输入事件：**  用户在应用程序中的交互操作，如鼠标点击、键盘按键、触摸屏输入等，都可以产生事件。这些事件由用户输入设备发出，并被Qt应用程序捕获和处理。
3. **Qt对象事件：**  Qt中的对象（例如QWidget、QTimer、QSocket等）可以发出自定义事件，这些事件由Qt对象自己产生并发送给其他对象。开发人员可以使用`QCoreApplication::postEvent`​或`QCoreApplication::sendEvent`​等方法来发送自定义事件。
4. **定时器事件：**  定时器事件是一种周期性事件，它由Qt中的定时器对象发出。定时器可以用来触发特定的操作，例如定期更新界面或执行后台任务。
5. **其他事件源：**  除了上述事件源之外，Qt还支持许多其他事件源，包括网络事件、数据库事件等。

事件源生成事件后，这些事件被传递给Qt的事件处理系统，然后分发给适当的Qt对象进行处理。

‍

### 1.3 谁接受事件

事件由继承自QObject的对象接受和处理。这些接收事件的对象通常是Qt的各种组件、窗口、部件以及自定义的Qt对象。事件被分发给这些对象的事件处理函数，这些函数是被重写以处理特定类型的事件。以下是一些常见的事件处理函数：

1. **QWidget的事件处理函数：**  QWidget及其子类（如QMainWindow、QDialog等）可以重写各种事件处理函数，包括鼠标事件、键盘事件、绘图事件等。例如，`mousePressEvent`​、`keyPressEvent`​、`paintEvent`​等。
2. **QObject的自定义事件处理函数：**  你可以为自定义的QObject子类定义自己的事件处理函数，以处理自定义事件。这些事件处理函数的名称可以自己定义，只要它们的参数与特定类型的事件匹配即可。
3. **定时器事件处理函数：**  通过使用`QTimer`​类，你可以创建定时器事件，并将其与特定的QObject对象关联。然后，你可以重写对象的`timerEvent`​函数来处理定时器事件。
4. **其他Qt对象的事件处理函数：**  除了QWidget和QObject，其他Qt对象（如QIODevice、QNetworkReply等）也可以有自己的事件处理函数来处理与其相关的事件。

当事件发生时，Qt会查找目标对象并将事件传递给适当的事件处理函数。事件处理函数根据事件类型和属性来执行相应的操作。如果没有适合的事件处理函数，事件会被忽略或传递给父对象，直到找到能够处理该事件的对象为止。

‍

### 1.4 事件类型

事件类型由`QEvent::Type`​枚举表示，它定义了各种不同类型的事件。以下是一些常见的事件类型：

1. ​**`QEvent::MouseButtonPress`**​ **：**  鼠标按钮按下事件，表示用户点击鼠标按钮。
2. ​**`QEvent::MouseButtonRelease`**​ **：**  鼠标按钮释放事件，表示用户释放鼠标按钮。
3. ​**`QEvent::MouseMove`**​ **：**  鼠标移动事件，表示鼠标在窗口内移动。
4. ​**`QEvent::KeyPress`**​ **：**  键盘按键按下事件，表示用户按下键盘上的键。
5. ​**`QEvent::KeyRelease`**​ **：**  键盘按键释放事件，表示用户释放键盘上的键。
6. ​**`QEvent::Resize`**​ **：**  窗口尺寸调整事件，表示窗口的大小发生变化。
7. ​**`QEvent::Paint`**​ **：**  绘图事件，表示需要绘制窗口的内容。
8. ​**`QEvent::Close`**​ **：**  窗口关闭事件，表示用户关闭了窗口。
9. ​**`QEvent::Timer`**​ **：**  定时器事件，表示定时器到期触发的事件。
10. ​**`QEvent::Custom`**​ **：**  自定义事件，可以创建和发送自定义事件，用于特定的应用需求。
11. ​**`QEvent::FocusIn`**​ ** 和 **​**`QEvent::FocusOut`**​ **：**  焦点事件，表示窗口获得或失去焦点。
12. ​**`QEvent::Wheel`**​ **：**  鼠标滚轮事件，表示用户使用鼠标滚轮。
13. ​**`QEvent::ContextMenu`**​ **：**  上下文菜单事件，表示用户请求上下文菜单。
14. ​**`QEvent::HoverEnter`**​ ** 和 **​**`QEvent::HoverLeave`**​ **：**  鼠标悬停事件，表示鼠标进入或离开窗口部件。
15. ​**`QEvent::DragEnter`**​ ** 和 **​**`QEvent::DragLeave`**​ **：**  拖拽事件，表示拖拽操作的开始和结束。
16. ​**`QEvent::Drop`**​ **：**  放置事件，表示拖拽操作的放置。
17. ​**`QEvent::WindowStateChange`**​ **：**  窗口状态变化事件，表示窗口最大化、最小化等状态变化。
18. ............

‍

### 1.5 怎么处理事件

处理事件的主要方法是通过重写相应的事件处理函数。每个Qt对象都可以有不同类型的事件处理函数，你可以根据需要重写这些函数以处理特定类型的事件。以下是处理事件的基本步骤：

1. **选择要处理的事件类型：**  首先，确定你希望处理哪种类型的事件。例如，如果你想处理鼠标点击事件，你需要重写`mousePressEvent`​函数；如果你想处理键盘按键事件，你需要重写`keyPressEvent`​函数。
2. **在你的Qt对象中重写事件处理函数：**  创建继承自QObject或QWidget的自定义类，并在其中重写所选的事件处理函数。确保函数的参数与事件类型匹配。
3. **处理事件：**  在事件处理函数中编写代码来处理事件。你可以访问事件的属性和信息，并根据事件的类型执行适当的操作。
4. **可选：传递或忽略事件：**  在事件处理函数中，你可以选择是否传递事件给父对象或其他对象，或者完全忽略事件。使用`event->accept()`​来接受事件，或使用`event->ignore()`​来忽略事件。

以下是一个示例，展示如何处理鼠标点击事件：

```cpp
class MyWidget : public QWidget
{
    Q_OBJECT

protected:
    void mousePressEvent(QMouseEvent *event) override
    {
        if (event->button() == Qt::LeftButton)
        {
            // 处理左键点击事件
            qDebug() << "Left mouse button clicked at" << event->pos();
        }
        else if (event->button() == Qt::RightButton)
        {
            // 处理右键点击事件
            qDebug() << "Right mouse button clicked at" << event->pos();
        }

        // 接受事件
        event->accept();
    }
};
```

在上面的示例中，创建了一个自定义的QWidget子类`MyWidget`​，并重写了`mousePressEvent`​函数来处理鼠标点击事件。在函数中，检查事件的按钮类型，执行相应的操作，并最后使用``​来接受事件。

> 在Qt中，使用`event->accept()`​或`event->ignore()`​是控制事件处理流程的一种方式，但不一定要在每个事件处理函数中都使用这些函数。具体是否需要使用取决于事件类型和你的应用程序的需求。
>
> * 如果你希望在当前事件处理函数中处理完事件后，将事件传递给父对象或其他对象继续处理，那么可以调用`event->accept()`​来接受事件。这意味着你的事件处理函数处理了事件，并允许事件继续传递。
> * 如果你希望在当前事件处理函数中处理完事件后，不再传递事件给其他对象，你可以调用`event->ignore()`​来忽略事件。这意味着你的事件处理函数处理了事件，不希望其他对象进一步处理。
>
> 如果你不调用这两个函数中的任何一个，事件处理系统会根据默认规则自动确定是否要接受或忽略事件。通常，对于大多数事件处理函数，如果你不显式调用`event->accept()`​或`event->ignore()`​，事件将被接受并且继续传递给父对象（如果有的话）。

需要注意的是，可以在多个事件处理函数中处理不同类型的事件，以满足应用程序的需求。Qt的事件处理系统允许你响应用户交互和系统状态变化，以实现各种功能和交互性。

‍

‍
